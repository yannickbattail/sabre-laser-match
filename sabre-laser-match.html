<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta charset="utf-8">
    <title>Sabre laser - match</title>
    <style>
      .dark {
        color: rgb(100, 200, 255);
        background-color: rgba(30,30,30);
      }
      .dark button, .dark input {
        color: rgb(100, 200, 255);
        background-color: rgba(60,60,60);
        border-color: rgb(100, 200, 255);
        border-radius: 5px;
      }
      button {
        margin: 10px;
        padding: 10px;
      }
      button img {
        width: 30px;
        height: 30px;
      }
      #scoreVert, #scoreRouge {
        width: 40px;
        font-size: 20px;
        text-align: center;
      }
      .vertCombattant {
        color: chartreuse;
      }
      .rougeCombattant {
        color: red;
      }
      .blancCarton {
        color: black;
        background-color: white;
      }
      .jauneCarton {
        color: black;
        background-color: yellow;
      }
      .rougeCarton {
        color: black;
        background-color: red;
      }
      .noirCarton {
        color: white;
        background-color: black;
      }
      #restant {
        font-size: 20px;
      }
      body {
        text-align: center;
      }
    </style>
  </head>
  <body class="dark">
  <span id="restant">00:00</span>
  <button id="start" onclick="start()">&gt; </button>
  <button id="reset" onclick="reset()">reset</button>
  <table style="width:100%">
    <thead>
      <tr>
        <th><span class="vertCombattant">Vert</span></th>
        <th><span class="rougeCombattant">Rouge</span></th>
      </tr>
    </thead>
    <tbody>
    <tr>
      <td>
        <input type="text" id="scoreVert" value="0" readonly="readonly" autocomplete='off' />
      </td>
      <td>
        <input type="text" id="scoreRouge" value="0" readonly="readonly" autocomplete='off' />
      </td>
    </tr>
    <tr>
      <td>
        <button onclick="touche('main', 'vert')"><img src="images/main.svg" alt="carton blanc" /></button>
        <button onclick="touche('bras', 'vert')"><img src="images/bras.svg" alt="carton blanc" /></button>
        <button onclick="touche('jambe', 'vert')"><img src="images/jambe.svg" alt="carton blanc" /></button>
        <button onclick="touche('tronc', 'vert')"><img src="images/torse.svg" alt="carton blanc" /></button>
        <button onclick="touche('tete', 'vert')"><img src="images/tete.svg" alt="carton blanc" /></button>
      </td>
      <td>
        <button onclick="touche('main', 'rouge')"><img src="images/main.svg" alt="carton blanc" /></button>
        <button onclick="touche('bras', 'rouge')"><img src="images/bras.svg" alt="carton blanc" /></button>
        <button onclick="touche('jambe', 'rouge')"><img src="images/jambe.svg" alt="carton blanc" /></button>
        <button onclick="touche('tronc', 'rouge')"><img src="images/torse.svg" alt="carton blanc" /></button>
        <button onclick="touche('tete', 'rouge')"><img src="images/tete.svg" alt="carton blanc" /></button>
      </td>
    </tr>
    <tr>
      <td>
        <button onclick="carton('blanc', 'vert')"><img src="images/carton-blanc.svg" alt="carton blanc" /></button>
        <button onclick="carton('jaune', 'vert')"><img src="images/carton-jaune.svg" alt="carton jaune" /></button>
        <button onclick="carton('rouge', 'vert')"><img src="images/carton-rouge.svg" alt="carton rouge" /></button>
        <button onclick="carton('noir', 'vert')"><img src="images/carton-noir.svg" alt="carton noir" /></button>
      </td>
      <td>
        <button onclick="carton('blanc', 'rouge')"><img src="images/carton-blanc.svg" alt="carton blanc" /></button>
        <button onclick="carton('jaune', 'rouge')"><img src="images/carton-jaune.svg" alt="carton jaune" /></button>
        <button onclick="carton('rouge', 'rouge')"><img src="images/carton-rouge.svg" alt="carton rouge" /></button>
        <button onclick="carton('noir', 'rouge')"><img src="images/carton-noir.svg" alt="carton noir" /></button>
      </td>
    </tr>
    </tbody>
  </table>
  <div id="historique"></div>
  <button onclick="annuler()">Annuler la derni√®re action</button>
  <script>
    class Event {
      temps;
      combattant;
      type;
      nom;
      constructor(temps, combattant, type, nom) {
        this.temps = temps;
        this.combattant = combattant;
        this.type = type;
        this.nom = nom;
      }
    }
    const CARTONS = {
      blanc: {
        couleur: 'blanc',
        points: 0
      },
      jaune:{
        couleur: 'jaune',
        points: 3
      },
      rouge:{
        couleur: 'rouge',
        points: 5
      },
      noir:{
        couleur: 'noir',
        points: 0
      }
    };
    const TOUCHES = {
      main: {
        points: 1
      },
      bras:{
        points: 3
      },
      jambe:{
        points: 3
      },
      tronc:{
        points: 5
      },
      tete:{
        points: 5
      },
    };
    const duree = 180;
    let historique = [];
    let time = 0;
    let status = 'pret';
    let intervalID = null;
    function carton(carton, combatant) {
      historique.push(new Event(time, combatant, 'carton', carton));
      refresh();
    }
    function touche(type, combatant) {
      historique.push(new Event(time, combatant, 'touche', type));
      refresh();
    }
    function annuler() {
      historique.pop();
      refresh();
    }
    function formatCombattant(combattant) {
      return `<span class="${combattant}Combattant">${combattant}</span>`;
    }
    function formatCarton(carton) {
      return `<span class="${carton}Carton">${carton}</span>`;
    }
    function ajoutHistorique(event) {
      const historiqueDiv = document.getElementById("historique");
      const div = document.createElement("div");
      const horodatage = `<span class="temps">[${formatTime(event.temps)}]</span>`
      if (event.type === 'carton') div.innerHTML = `${horodatage} combattant ${formatCombattant(event.combattant)}: ${event.type} ${formatCarton(event.nom)} (${CARTONS[event.nom].points} combattant ${autreComabattant(event.combattant)})`;
      else if (event.type === 'touche') div.innerHTML = `${horodatage} combattant ${formatCombattant(event.combattant)}: ${event.type} ${event.nom} (${TOUCHES[event.nom].points})`;
      historiqueDiv.prepend(div);
      historiqueDiv.scrollTop = historiqueDiv.scrollHeight;
    }

    function autreComabattant(combattant) {
      return combattant === 'vert' ? 'rouge' : 'vert';
    }
    function updateScore(combattant) {
      return historique
        .filter(e => (e.combattant === combattant && e.type === 'touche')
                 || (e.combattant === autreComabattant(combattant) && e.type === 'carton'))
        .map(e => {
          if (e.type === 'carton') return CARTONS[e.nom].points;
          else if (e.type === 'touche') return TOUCHES[e.nom].points;
          else return 0;
      }).reduce((a, b) => a + b, 0)
    }
    function updateTimer() {
      if (status === "en cours") {
        document.getElementById('start').innerText = "||";
      } else {
        document.getElementById('start').innerText = "> ";
      }
      document.getElementById('restant').innerText = formatTime(time);
    }
    function formatTime(time){
      return pad0(Math.floor(time / 60)) + ":" + pad0(time % 60);
    }
    function refresh() {
      const historiqueDiv = document.getElementById("historique");
      historiqueDiv.innerHTML = "";
      historique.map(e => ajoutHistorique(e));
      historiqueDiv.scrollTop = historiqueDiv.scrollHeight;
      document.getElementById('scoreVert').value = updateScore("vert");
      document.getElementById('scoreRouge').value = updateScore("rouge");
      updateTimer();
    }
    function atInterval() {
      if (time >= duree) {
        window.clearInterval(intervalID);
        status = "fini";
      } else {
        time++;
      }
      refresh();
    }
    function pad0(value) {
      return value<10?'0'+value:value;
    }
    function reset() {
      window.clearInterval(intervalID);
      time = 0;
      status = "pret";
      historique = [];
      refresh();
    }
    function start() {
      if (status === "en cours") {
        window.clearInterval(intervalID);
        status = "pause";
      } else if (status === "pause" || status === "pret") {
        intervalID = window.setInterval(atInterval, 1000);
        status = "en cours";
      } else if (status === "fini") {
        time = 0;
        intervalID = window.setInterval(atInterval, 1000);
        status = "en cours";
      }
      refresh();
    }
  </script>
  </body>
</html>
