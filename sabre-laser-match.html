<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta charset="utf-8">
    <title>Sabre laser - match</title>
    <style>
      .dark {
        color: rgb(100, 200, 255);
        background-color: rgba(30,30,30);
      }
      .dark button {
        color: rgb(100, 200, 255);
        background-color: rgba(60,60,60);
        border-color: rgb(100, 200, 255);
        border-radius: 5px;
      }
      button {
        margin: 10px;
        padding: 10px;
      }
      button:disabled,
      button[disabled],
      button[disabled=disabled] {
        border-color: rgb(30, 60, 75);
      }
        button img {
        width: 30px;
        height: 30px;
      }
      #scoreVert, #scoreRouge {
        width: 40px;
        font-size: 20px;
        text-align: center;
      }
      .vertCombattant {
        color: chartreuse;
      }
      .rougeCombattant {
        color: red;
      }
      .blancCarton {
        color: black;
        background-color: white;
      }
      .jauneCarton {
        color: black;
        background-color: yellow;
      }
      .rougeCarton {
        color: black;
        background-color: red;
      }
      .noirCarton {
        color: white;
        background-color: black;
      }
      #restant {
        font-size: 20px;
      }
      body {
        text-align: center;
      }
    </style>
  </head>
  <body class="dark">
  <span id="restant">00:00</span>
  <button id="start" onclick="start()"><img src="images/play.svg" alt="démarrer le combat" /></button>
  <button id="reset" onclick="reset()">Nouveau combat</button>
  <button onclick="annuler()"><img src="images/abort.svg" alt="supprimer la dernière action" /></button>
  <table style="width:100%">
    <thead>
      <tr>
        <th id="message" colspan="2"></th>
      </tr>
      <tr>
        <th><span class="vertCombattant">Vert</span></th>
        <th><span class="rougeCombattant">Rouge</span></th>
      </tr>
    </thead>
    <tbody>
    <tr>
      <td id="scoreVert">
        0
      </td>
      <td id="scoreRouge">
        0
      </td>
    </tr>
    <tr>
      <td>
        <button class="touche main" onclick="touche('main', 'vert')"><img src="images/main.svg" alt="carton blanc" /></button>
        <button class="touche bras"  onclick="touche('bras', 'vert')"><img src="images/bras.svg" alt="carton blanc" /></button>
        <button class="touche jambe"  onclick="touche('jambe', 'vert')"><img src="images/jambe.svg" alt="carton blanc" /></button>
        <button class="touche tronc"  onclick="touche('tronc', 'vert')"><img src="images/torse.svg" alt="carton blanc" /></button>
        <button class="touche tete"  onclick="touche('tete', 'vert')"><img src="images/tete.svg" alt="carton blanc" /></button>
      </td>
      <td>
        <button class="touche main"  onclick="touche('main', 'rouge')"><img src="images/main.svg" alt="carton blanc" /></button>
        <button class="touche bras"  onclick="touche('bras', 'rouge')"><img src="images/bras.svg" alt="carton blanc" /></button>
        <button class="touche jambe"  onclick="touche('jambe', 'rouge')"><img src="images/jambe.svg" alt="carton blanc" /></button>
        <button class="touche tronc"  onclick="touche('tronc', 'rouge')"><img src="images/torse.svg" alt="carton blanc" /></button>
        <button class="touche tete"  onclick="touche('tete', 'rouge')"><img src="images/tete.svg" alt="carton blanc" /></button>
      </td>
    </tr>
    <tr>
      <td>
        <button class="carton blanc" onclick="carton('blanc', 'vert')"><img src="images/carton-blanc.svg" alt="carton blanc" /></button>
        <button class="carton jaune" onclick="carton('jaune', 'vert')"><img src="images/carton-jaune.svg" alt="carton jaune" /></button>
        <button class="carton rouge" onclick="carton('rouge', 'vert')"><img src="images/carton-rouge.svg" alt="carton rouge" /></button>
        <button class="carton noir" onclick="carton('noir', 'vert')"><img src="images/carton-noir.svg" alt="carton noir" /></button>
      </td>
      <td>
        <button class="carton blanc" onclick="carton('blanc', 'rouge')"><img src="images/carton-blanc.svg" alt="carton blanc" /></button>
        <button class="carton jaune" onclick="carton('jaune', 'rouge')"><img src="images/carton-jaune.svg" alt="carton jaune" /></button>
        <button class="carton rouge" onclick="carton('rouge', 'rouge')"><img src="images/carton-rouge.svg" alt="carton rouge" /></button>
        <button class="carton noir" onclick="carton('noir', 'rouge')"><img src="images/carton-noir.svg" alt="carton noir" /></button>
      </td>
    </tr>
    </tbody>
  </table>
  <div id="historique"></div>
  <script>
    class NodeUpdate {
      static hasChanged(node1, node2) {
        if (node1.nodeType !== node2.nodeType) return true;
        if (node1.nodeName !== node2.nodeName) return true;
        return node1.nodeType == Node.TEXT_NODE && node1.textContent !== node2.textContent;
      }

      static updateAttributes(oldNode, newNode) {
        const attrToRm = oldNode.getAttributeNames().filter((attr) => newNode.getAttributeNames().indexOf(attr) === -1);
        attrToRm.forEach((attr) => oldNode.removeAttribute(attr));

        for (let i = 0; i < newNode.attributes.length; ++i) {
          if (
                  !oldNode.hasAttribute(newNode.attributes[i].name) ||
                  oldNode.getAttribute(newNode.attributes[i].name) != newNode.attributes[i].value
          ) {
            oldNode.setAttribute(newNode.attributes[i].name, newNode.attributes[i].value);
          }
        }
      }

      static updateChildren(oldNode, newNode) {
        const newNodeLength = newNode.childNodes.length;
        const oldNodeLength = oldNode.childNodes.length;
        const maxLength = Math.max(newNodeLength, oldNodeLength);
        for (let i = 0; i < maxLength; i++) {
          if (i >= oldNodeLength) {
            try {
              oldNode.appendChild(newNode.childNodes[i].cloneNode(true));
            } catch (e) {
              console.log(e);
            }
          } else if (i >= newNodeLength) {
            oldNode.removeChild(oldNode.childNodes[newNodeLength]);
          } else {
            const oldChild = oldNode.childNodes[i];
            const newChild = newNode.childNodes[i];
            if (NodeUpdate.hasChanged(oldChild, newChild)) {
              oldNode.replaceChild(newChild.cloneNode(true), oldChild);
            } else {
              NodeUpdate.updateChildren(oldChild, newChild);

              if (oldChild instanceof HTMLElement && newChild instanceof HTMLElement) {
                NodeUpdate.updateAttributes(oldChild, newChild);
              }
            }
          }
        }
      }

      static updateDiv(id, html) {
        const oldDiv = document.getElementById(id);
        if (oldDiv != null) {
          const newDiv = document.createElement('div');
          newDiv.innerHTML = html;
          NodeUpdate.updateChildren(oldDiv, newDiv);
        }
      }
    }

    class Event {
      temps;
      combattant;
      type;
      nom;
      constructor(temps, combattant, type, nom) {
        this.temps = temps;
        this.combattant = combattant;
        this.type = type;
        this.nom = nom;
      }
    }
    const CARTONS = {
      blanc: {
        couleur: 'blanc',
        points: 0
      },
      jaune:{
        couleur: 'jaune',
        points: 3
      },
      rouge:{
        couleur: 'rouge',
        points: 5
      },
      noir:{
        couleur: 'noir',
        points: 0
      }
    };
    const TOUCHES = {
      main: {
        points: 1
      },
      bras:{
        points: 3
      },
      jambe:{
        points: 3
      },
      tronc:{
        points: 5
      },
      tete:{
        points: 5
      },
    };
    const duree = 180;
    const scroreMax = 15;
    let historique = [];
    let time = 0;
    let status = 'pret'; // "pret" "en cours" "pause" "fini"
    let intervalID = null;
    function carton(carton, combatant) {
      historique.push(new Event(time, combatant, 'carton', carton));
      refresh();
    }
    function touche(type, combatant) {
      historique.push(new Event(time, combatant, 'touche', type));
      refresh();
    }
    function annuler() {
      historique.pop();
      refresh();
    }
    function formatCombattant(combattant) {
      return `<span class="${combattant}Combattant">${combattant}</span>`;
    }
    function formatCarton(carton) {
      return `<span class="${carton}Carton">${carton}</span>`;
    }
    function ajoutHistorique(event) {
      const horodatage = `<span class="temps">[${formatTime(event.temps)}]</span>`
      if (event.type === 'carton') {
        return `<div>${horodatage} combattant ${formatCombattant(event.combattant)}: ${event.type} ${formatCarton(event.nom)} (${CARTONS[event.nom].points} combattant ${autreComabattant(event.combattant)})</div>`;
      }
      else if (event.type === 'touche') {
        return `<div>${horodatage} combattant ${formatCombattant(event.combattant)}: ${event.type} ${event.nom} (${TOUCHES[event.nom].points})</div>`;
      }
    }

    function autreComabattant(combattant) {
      return combattant === 'vert' ? 'rouge' : 'vert';
    }
    function calcScore(combattant) {
      return historique
        .filter(e => (e.combattant === combattant && e.type === 'touche')
                 || (e.combattant === autreComabattant(combattant) && e.type === 'carton'))
        .map(e => {
          if (e.type === 'carton') return CARTONS[e.nom].points;
          else if (e.type === 'touche') return TOUCHES[e.nom].points;
          else return 0;
      }).reduce((a, b) => a + b, 0)
    }
    function updateTimer() {
      if (status === "en cours") {
        document.getElementById('start').innerHTML = '<img src="images/pause.svg" alt="mettre en pause le combat" />';
      } else {
        document.getElementById('start').innerHTML = '<img src="images/play.svg" alt="démarrer le combat" />';
      }
      document.getElementById('restant').innerText = formatTime(time);
    }
    function formatTime(time){
      return pad0(Math.floor(time / 60)) + ":" + pad0(time % 60);
    }
    function refresh() {
      let html = "";
      for (let i = historique.length-1; i >= 0; i--) {
        html += ajoutHistorique(historique[i]);
      }
      NodeUpdate.updateDiv("historique", html);
      document.getElementById('scoreVert').innerHTML = calcScore("vert");
      document.getElementById('scoreRouge').innerHTML = calcScore("rouge");
      activeButtons(status !== "pret");
      updateTimer();
    }
    function activeButtons(active) {
      const touche = document.getElementsByClassName("touche");
      for (let i = 0; i < touche.length ; i++) {
        touche[i].disabled = !active;
      }
      const carton = document.getElementsByClassName("carton");
      for (let i = 0; i < carton.length ; i++) {
        carton[i].disabled = !active;
      }
    }
    function atInterval() {
      if (time >= duree || calcScore("vert") >= scroreMax || calcScore("rouge") >= scroreMax) {
        window.clearInterval(intervalID);
        status = "fini";
        document.getElementById('message').innerHTML = win();
      } else {
        time++;
      }
      refresh();
    }
    function win() {
      if (calcScore("vert") > calcScore("rouge")) {
        return `Le combattant ${formatCombattant("vert")} gagne le combat!`;
      } else if (calcScore("rouge") > calcScore("vert")) {
        return `Le combattant ${formatCombattant("rouge")} gagne le combat!`;
      } else {
        return `Combattants ex aequo!`;
      }
    }
    function pad0(value) {
      return value<10?'0'+value:value;
    }
    function reset() {
      window.clearInterval(intervalID);
      time = 0;
      status = "pret";
      historique = [];
      refresh();
    }
    function start() {
      if (status === "en cours") {
        window.clearInterval(intervalID);
        status = "pause";
      } else if (status === "pause" || status === "pret") {
        intervalID = window.setInterval(atInterval, 1000);
        status = "en cours";
      } else if (status === "fini") {
        time = 0;
        intervalID = window.setInterval(atInterval, 1000);
        status = "en cours";
      }
      refresh();
    }
    refresh();
  </script>
  </body>
</html>
